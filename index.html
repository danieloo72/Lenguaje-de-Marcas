<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Galería de Coches</title>
        <link rel="stylesheet" href="style_index.css">
    </head>
    <body>
        <h1>Lista de Coches</h1>

        <label>Buscar nombre del coche: </label>
        <input type="text" id="buscarCoches" placeholder="Escribe el nombre del coche">
        
        <button id="mostrarTodosCoches">Mostrar todos los coches</button><br><br>

        <label>Buscar por filtros: </label>
        <label>Filtrar por marca: </label>
        <select id="filtroMarca">
            <option value="">Todas las marcas</option>
            <option value="mercedes">Mercedes</option>
            <option value="bugatti">Bugatti</option>
            <option value="rolls-royce">Rolls-Royce</option>
            <option value="pagani">Pagani</option>
        </select>

        <label>Filtrar por año: </label>
        <input type="number" id="filtroAño" min="0" placeholder="Año">

        <label>Filtrar por precio máximo: </label>
        <input type="number" id="filtroPrecio" placeholder="Precio en millones">

        <button id="borrar">borrar</button>
        <hr>
        <div id="resultado"></div>

        <dialog id="modalCoche">
            <h2 id="modalTitulo">Marca Modelo</h2>
            <img id="modalImagen" src="">
            <p><strong>Año: </strong> <span id="modalAño"></span></p>
            <p><strong>Precio: </strong> <span id="modalPrecio"></span></p>
            <hr>
            <p><strong>Descripción: </strong></p>
            <p id="modalDescripcion"></p>
            <button id="cerrarModal">cerrar</button>
        </dialog>

        <button id="botonRegistro">Ir a Registro</button>

        <script>
            let todosLosCoches = [];

            const botonMostrarTodosCoches = document.getElementById("mostrarTodosCoches");
            const botonBorrar = document.getElementById("borrar");
            const botonRegistro = document.getElementById("botonRegistro");
            const inputCoche = document.getElementById("buscarCoches"); 
            const selectMarca = document.getElementById("filtroMarca");
            const inputAño = document.getElementById("filtroAño");
            const inputPrecio = document.getElementById("filtroPrecio");
            const resultado = document.getElementById("resultado");

            const modal = document.getElementById("modalCoche");
            const botonCerrarModal = document.getElementById("cerrarModal");
            const modalTitulo = document.getElementById("modalTitulo");
            const modalAño = document.getElementById("modalAño");
            const modalPrecio = document.getElementById("modalPrecio");
            const modalDescripcion = document.getElementById("modalDescripcion");
            const modalImagen = document.getElementById("modalImagen");

            function abrirModal(coche) {
                modalTitulo.innerText = `${coche.marca} ${coche.modelo}`;
                modalAño.innerText = coche.año;
                modalPrecio.innerText = coche.precio;
                modalDescripcion.innerText = coche.descripcion;
                modalImagen.src = coche.imagen;

                modal.showModal();
            }

            botonCerrarModal.addEventListener("click", () => {
                modal.close();
            });

            function mostrarCoches(coches) {
                resultado.innerHTML = "";
                if (coches.length == 0) {
                    resultado.innerHTML = "<p>No se ha encontrado ningún coche</p>";
                    return;
                }
                resultado.innerHTML = `<h2>Coches encontrados (${coches.length}):</h2>`;

                coches.forEach((coche) => {
                    const divCoche = document.createElement("div");
                    divCoche.className = "informacionCoche";

                    divCoche.innerHTML += `
                        <h3>${coche.marca} ${coche.modelo}</h3>
                        <img src="${coche.imagen}" alt="${coche.modelo}">
                    `;

                    const botonModal = document.createElement("button");
                    botonModal.innerText = "Más Información";

                    botonModal.addEventListener("click", function() {
                        abrirModal(coche);
                    });

                    divCoche.appendChild(botonModal);
                    resultado.appendChild(divCoche);
                });
            }

            function filtrar() {
                const textoBusqueda = inputCoche.value.toLowerCase();
                const marcaSeleccionada = selectMarca.value.toLowerCase();
                const añoSeleccionado = inputAño.value ? parseInt(inputAño.value) : null;
                const precioSeleccionado = inputPrecio.value ? parseInt(inputPrecio.value): null;

                const cochesFiltrados = todosLosCoches.filter((coche) => {
                    const coincideMarca = marcaSeleccionada ? coche.marca.toLowerCase() === marcaSeleccionada : true;
                    const coincideAño = añoSeleccionado ? coche.año === añoSeleccionado : true;
                    const coincidePrecio = precioSeleccionado ? parseInt(coche.precio) <= precioSeleccionado : true;
                    const coincideBusqueda = textoBusqueda === "" || coche.marca.toLowerCase().includes(textoBusqueda) || coche.modelo.toLowerCase().includes(textoBusqueda);

                    return coincideMarca && coincideAño && coincidePrecio && coincideBusqueda;
                });

                mostrarCoches(cochesFiltrados);
            }

            botonBorrar.addEventListener("click", function() {
                inputCoche.value = "";
                selectMarca.value = "";
                inputAño.value = "";
                inputPrecio.value = "";

                filtrar();
            });

            botonRegistro.addEventListener("click", () => {
                window.location.href = "registro.html";
            });

            function cargarDatos() {
                fetch("galeria.xml")
                    .then((response) => response.text())
                    .then((data) => {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(data, "text/xml");

                        todosLosCoches = [];
                        const cochesXML = xml.getElementsByTagName("coche");

                        for (let coche of cochesXML) {
                            let imagenUrl = coche.getElementsByTagName("imagen")[0].textContent;
                            todosLosCoches.push({
                                marca: coche.getElementsByTagName("marca")[0].textContent,  
                                modelo: coche.getElementsByTagName("modelo")[0].textContent,   
                                año: parseInt(coche.getElementsByTagName("año")[0].textContent),  
                                precio: coche.getElementsByTagName("precio")[0].textContent,
                                descripcion: coche.getElementsByTagName("descripcion")[0].textContent,
                                imagen: imagenUrl
                            });
                        }
                        mostrarCoches(todosLosCoches);
                    })
                    .catch(() => {
                        resultado.innerHTML = "<p>Error al cargar</p>";
                    });
            }
            botonMostrarTodosCoches.addEventListener("click", cargarDatos);
            document.addEventListener("DOMContentLoaded", cargarDatos);
            
            inputCoche.addEventListener("input", filtrar);
            selectMarca.addEventListener("change", filtrar);
            inputAño.addEventListener("input", filtrar);
            inputPrecio.addEventListener("input", filtrar);
        </script>
    </body>
</html>